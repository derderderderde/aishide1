<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配方管理</title>
    <style>
        .w100{width: 100vw;}

        body {
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 90%;
            margin: 20px auto;
        }
        .white-box {
            background-color: #ffffff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .green-box, .orange-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
        }
        .green-box {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .orange-box {
            background-color: #f7ede1;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        .label {
            font-size: 14px;
            color: #333;
            text-align: left;
        }
        .value {
            font-size: 14px;
            color: #333;
            width: 55%;
            text-align: right;
        }
        .van-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .van-col {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .van-col-left {
            text-align: left;
        }
        .van-col-right {
            text-align: right;
            margin-left: auto;
        }
        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height:20vh;
        }
        .image-container img {
            width: 100%;
            max-width: 100%;
        }
        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .log-address {
            text-align: left;
        }
        .log-time {
            text-align: right;
        }
        .expand-button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .scan-info {
            font-size: 14px;
            color: red;
            margin-left: 10px;
            font-weight: bold;
        }
        .thank-you-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* 控制文字和图片在容器中的排列方式 */
            margin-top: 10px;
        }

        .thank-you {
            text-align: left; /* 确保文字与图片在一行 */
            margin-left: 10px; /* 增加文字与图片之间的间距 */
            font-size: 14px;
            color: #ff8874;
        }

        .pass-image {
            display: flex;
            align-items: center; /* 图片在容器中的垂直居中 */
        }

        .pass-image img {
            width: 100%;
            height: auto;
        }

        .jinggao1-image {
            display: flex;
            align-items: center; /* 图片在容器中的垂直居中 */
        }

        .jinggao1-image img {
            width: 100%;
            height: auto;
        }
        


    </style>
</head>
<body>
    <div class="container">
        <!-- 验证结果白框 -->
        <div class="white-box" id="verification-box">
            <!-- 动态内容将在此显示 -->
        </div>

        <!-- 产品信息白框 -->
        <div class="white-box">
            <div class="van-row">
                <div class="van-col" style="line-height: 35px;">产品信息</div>
                <div class="van-col">
                    <div class="label">产品代号</div>
                    <div class="value">NS680-02</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">产品名称</div>
                    <div class="value">NS680-02慢干固剂(1升罐装)</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">品牌</div>
                    <div class="value">nason来胜</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">包装规格</div>
                    <div class="value">1升</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产批号</div>
                    <div class="value">6377</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产日期</div>
                    <div class="value">2024-03</div>
                </div>
            </div>
        </div>

        <!-- 位置和时间显示白框 -->
        <div class="white-box">
            <div id="location-info">
                <div class="van-row">
                    <div class="van-col">
                        <div class="value van-col-left" id="address" style="font-size: 14px;">正在获取位置...</div>                                         
                        <div class="value van-col-right" id="time" style="font-size: 14px;">正在获取时间...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 访问日志显示白框 -->
        <div class="white-box">
            <div class="van-col">
                <h3>扫码信息</h3>
                <span class="scan-info" id="scan-info">扫码0人0次</span>
                <button class="expand-button" id="toggle-log">展开</button>
            </div>
            <div id="visit-log" style="display: none; font-size: 14px;"></div>
        </div>

        <div class="image-container">
            <img src="jifen.jpg" alt="积分图片">
        </div>
    </div>

    <script>
        // 获取访问时间
        function getVisitTime() {
            const now = new Date();
            return now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
            });
        }

        // 获取地理位置
        function updateLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // 使用逆地理编码API获取具体位置
            const apiUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=zh`;
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const address = `${data.principalSubdivision} ${data.city} ${data.locality || data.localityInfo.administrative[2].name}`;
                    document.getElementById('address').textContent = address;
                    logVisit(address);
                })
                .catch(error => {
                    const errorMsg = '无法获取位置';
                    document.getElementById('address').textContent = errorMsg;
                    logVisit(errorMsg);
                    console.error('Error fetching location:', error);
                });
        }

        function handleLocationError() {
            const errorMsg = '位置获取失败';
            document.getElementById('address').textContent = errorMsg;
            logVisit(errorMsg);
        }

        // 记录访问日志并保存到localStorage
        function logVisit(address) {
            const time = getVisitTime();

            // 构建访问日志条目
            const logEntry = { address, time };

            // 从localStorage中获取当前日志
            let visitLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            let uniqueVisitors = JSON.parse(localStorage.getItem('uniqueVisitors')) || {};

            // 增加访问次数
            visitLog.push(logEntry);

            // 使用地址作为唯一标识符记录访问者
            if (!uniqueVisitors[address]) {
                uniqueVisitors[address] = true;
            }

            // 更新localStorage中的日志
            localStorage.setItem('visitLog', JSON.stringify(visitLog));
            localStorage.setItem('uniqueVisitors', JSON.stringify(uniqueVisitors));

            // 更新页面显示
            displayLog(visitLog);
            updateScanInfo(Object.keys(uniqueVisitors).length, visitLog.length);
            displayVerificationMessage(visitLog.length);
        }

        // 显示首次或多次访问的提示信息
        function displayVerificationMessage(visitCount) {
            const verificationBox = document.getElementById('verification-box');
            
            if (visitCount === 1) {
                verificationBox.innerHTML = `
                <div class="pass-image"><img src="pass2.jpg" alt="Pass Image"></div>
                    
                           
                
                     
                `;
            } else {
                verificationBox.innerHTML = `       
                <div class="jinggao1-image"><img src="jinggao2.jpg" alt="jinggao1 Image"></div> 
                                                    
                `;
            }
        }

        // 更新扫码次数信息
        function updateScanInfo(uniqueVisitorCount, visitCount) {
            const scanInfo = document.getElementById('scan-info');
            scanInfo.textContent = `扫码${uniqueVisitorCount}人${visitCount}次`;
        }

        // 在页面上显示访问日志
        function displayLog(logEntries) {
            const visitLog = document.getElementById('visit-log');
            visitLog.innerHTML = '';

            logEntries.forEach(entry => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-entry';
                logDiv.innerHTML = `
                    <div class="log-address">${entry.address}</div>
                    <div class="log-time">${entry.time}</div>
                `;
                visitLog.appendChild(logDiv);
            });
        }

        // 切换日志显示
        document.getElementById('toggle-log').addEventListener('click', function() {
            const visitLog = document.getElementById('visit-log');
            if (visitLog.style.display === 'none') {
                visitLog.style.display = 'block';
                this.textContent = '收起';
            } else {
                visitLog.style.display = 'none';
                this.textContent = '展开';
            }
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 显示当前时间
            document.getElementById('time').textContent = getVisitTime();

            // 获取当前地理位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updateLocation, handleLocationError);
            } else {
                handleLocationError();
            }

            // 显示存储的访问日志
            const visitLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            displayLog(visitLog);

            // 显示存储的访问者信息
            const uniqueVisitors = JSON.parse(localStorage.getItem('uniqueVisitors')) || {};
            updateScanInfo(Object.keys(uniqueVisitors).length, visitLog.length);

            // 显示防伪验证信息
            displayVerificationMessage(visitLog.length);
        });
    </script>
</body>
</html>
