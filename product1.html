<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配方管理</title>
    <style>
        body {
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 90%;
            margin: 20px auto;
        }
        .white-box {
            background-color: #ffffff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .label {
            font-weight: bold;
            color: #333;
            text-align: left;
        }
        .value {
            font-size: 16px;
            color: #333;
            width: 55%;
            text-align: right;
        }
        .van-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .van-col {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .van-col-left {
            text-align: left;
        }
        .van-col-right {
            text-align: right;
            margin-left: auto;
        }
        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .image-container img {
            width: 90%;
            max-width: 100%;
        }
        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .log-address {
            text-align: left;
        }
        .log-time, .log-device {
            text-align: right;
        }
        .expand-button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .scan-info {
            font-size: 14px;
            color: rgb(198, 0, 0);
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 产品信息白框 -->
        <div class="white-box">
            <!-- 产品信息 -->
            <div class="van-row">
                <div class="van-col">
                    <div class="label">产品代号</div>
                    <div class="value">NS680-02</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">产品名称</div>
                    <div class="value">NS680-02慢干固剂(1升罐装)</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">品牌</div>
                    <div class="value">nason来胜</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">包装规格</div>
                    <div class="value">1升</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产批号</div>
                    <div class="value">6377</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产日期</div>
                    <div class="value">2024-03</div>
                </div>
            </div>
        </div>

        <!-- 位置和时间显示白框 -->
        <div class="white-box">
            <div id="location-info">
                <div class="van-row">
                    <div class="van-col">
                        <div class="value van-col-left" id="address">正在获取位置...</div>                                         
                        <div class="value van-col-right" id="time">正在获取时间...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 访问日志显示白框 -->
        <div class="white-box">
            <div class="van-col">
                <h3>扫码信息</h3>
                <span class="scan-info" id="scan-info" style="font-weight: bold;">扫码0人0次</span>
                <button class="expand-button" id="toggle-log">展开</button>
            </div>
            <div id="visit-log" style="display: none;"></div>
        </div>

        <div class="image-container">
            <img src="jifen.jpg" alt="积分图片">
        </div>
    </div>

    <script>
        // 获取访问时间
        function getVisitTime() {
            const now = new Date();
            return now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
            });
        }

      

        // 获取地理位置
        function updateLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // 使用逆地理编码API获取具体位置
            const apiUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=zh`;
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const address = `${data.principalSubdivision} ${data.city} ${data.locality || data.localityInfo.administrative[2].name}`;
                    document.getElementById('address').textContent = address;
                    logVisit(address);
                })
                .catch(error => {
                    const errorMsg = '无法获取位置';
                    document.getElementById('address').textContent = errorMsg;
                    logVisit(errorMsg);
                    console.error('Error fetching location:', error);
                });
        }

        function handleLocationError() {
            const errorMsg = '位置获取失败';
            document.getElementById('address').textContent = errorMsg;
            logVisit(errorMsg);
        }

        // 记录访问日志并保存到localStorage
        function logVisit(address) {
            const time = getVisitTime();
            const device = getDeviceType();

            // 构建访问日志条目
            const logEntry = { address, time, device };

            // 从localStorage中获取当前日志
            let visitLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            let uniqueVisitors = JSON.parse(localStorage.getItem('uniqueVisitors')) || {};

            // 增加访问次数
            visitLog.push(logEntry);

            // 使用设备类型作为唯一标识符记录访问者
            if (!uniqueVisitors[device]) {
                uniqueVisitors[device] = true;
            }

            // 更新localStorage中的日志
            localStorage.setItem('visitLog', JSON.stringify(visitLog));
            localStorage.setItem('uniqueVisitors', JSON.stringify(uniqueVisitors));

            // 更新页面显示
            displayLog(visitLog);
            updateScanInfo(Object.keys(uniqueVisitors).length, visitLog.length);
        }

        // 显示日志记录
        function displayLog(visitLog) {
            const logContainer = document.getElementById('visit-log');
            logContainer.innerHTML = ''; // 清除当前显示

            // 遍历日志记录并显示
            visitLog.forEach(logEntry => {
                const logElement = document.createElement('div');
                logElement.className = 'log-entry';

                const logAddress = document.createElement('div');
                logAddress.className = 'log-address';
                logAddress.textContent = logEntry.address;

                const logTime = document.createElement('div');
                logTime.className = 'log-time';
                logTime.textContent = logEntry.time;

                const logDevice = document.createElement('div');
                logDevice.className = 'log-device';
                logDevice.textContent = logEntry.device;

                logElement.appendChild(logAddress);
                logElement.appendChild(logTime);
                logElement.appendChild(logDevice);

                logContainer.appendChild(logElement);
            });
        }

        // 更新扫码信息显示
        function updateScanInfo(uniqueVisitorsCount, totalVisitsCount) {
            const scanInfo = document.getElementById('scan-info');
            scanInfo.textContent = `扫码${uniqueVisitorsCount}人${totalVisitsCount}次`;
        }

        // 切换日志显示
        document.getElementById('toggle-log').addEventListener('click', function() {
            const logContainer = document.getElementById('visit-log');
            const toggleButton = document.getElementById('toggle-log');
            
            if (logContainer.style.display === 'none') {
                logContainer.style.display = 'block';
                toggleButton.textContent = '收起';
            } else {
                logContainer.style.display = 'none';
                toggleButton.textContent = '展开';
            }
        });

        // 初始化页面
        window.onload = function() {
            // 设置访问时间
            document.getElementById('time').textContent = getVisitTime();

            // 获取访问者的地理位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updateLocation, handleLocationError);
            } else {
                const errorMsg = '浏览器不支持地理定位';
                document.getElementById('address').textContent = errorMsg;
                logVisit(errorMsg);
            }

            // 显示之前的日志记录
            const visitLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            const uniqueVisitors = JSON.parse(localStorage.getItem('uniqueVisitors')) || {};
            displayLog(visitLog);
            updateScanInfo(Object.keys(uniqueVisitors).length, visitLog.length);
        };
    </script>
</body>
</html>
