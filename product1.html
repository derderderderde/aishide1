<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配方管理</title>
    <style>
        /* 全局样式 */
        body {
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 100%;
            margin: 0px auto;
        }
        .white-box {
            background-color: #ffffff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 87vw;
            align-items: center;
            margin-left: 3%;
        }
       
        .label, .value {
            font-size: 16px;
            color: #333;
        }
        .value {
            width: 60%;
            text-align: right;
        }
        .van-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .van-col {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         /* 图片样式 */
         .van-col img {
            margin-right: -175px; /* 图片与文字之间的间距 */
        }

        /* 标题样式 */
        .van-col h4 {
            margin: 0;
        }

        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 20vh;
        }
        .image-container img {
            width: 100%;
            max-width: 100%;
        }
        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .expand-button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .scan-info {
            font-size: 14px;
            color: rgb(197, 20, 20);
            margin-left: -170px;
            font-weight: bold;
        }

        /* 插图样式 */
        .jinggao1-image {
            width: 100%;
            display: flex;
            justify-content: center; /* 水平居中 */
            align-items: center;    /* 垂直居中 */
        }

        .jinggao1-image img {
            width: 100%; /* 全覆盖视口宽度 */
            height: auto;
        }

        .jinggao-image img {
            width: 100%;
            height: auto;
        }

         /* 将 biaoshi3.jpg 固定在页面右侧中间位置 */
         .fixed-image {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
        }

    </style>
</head>
<body>
    <a href="jilu.html">
        <div class="jinggao1-image"><img src="fan4.jpg" alt="fan4 Image"></div> 
    </a>
    
    <div class="container">  
        <!-- 验证结果白框 -->
        <div class="w100" id="verification-box">
            <!-- 动态内容将在此显示 -->
        </div>

        <img src="biaoshi3.jpg" class="fixed-image" alt="右侧固定图片">
        <!-- 产品信息白框 -->
        <div class="white-box">
            <div class="van-row">
                <div class="van-col" style="margin-right: 315px;">
                    <img src="biaoshi1.jpg">
                    <h4>产品信息:</h4>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">产品代号</div>
                    <div class="value">NS680-02</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">产品名称</div>
                    <div class="value">NS680-02慢干固剂(1升罐装)</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">品牌</div>
                    <div class="value">nason来胜</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">包装规格</div>
                    <div class="value">1升</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产批号</div>
                    <div class="value">6377</div>
                </div>
            </div>
            <div class="van-row">
                <div class="van-col">
                    <div class="label">生产日期</div>
                    <div class="value">2024-03</div>
                </div>
            </div>
        </div>

        <!-- 位置和时间显示白框 -->
        <div class="white-box">
            <div id="location-info">
                <div class="van-row">
                    <div class="van-col">
                        <div class="value van-col-left" id="address" style="font-size: 16px;">正在获取位置...</div>                                         
                        <div class="value van-col-right" id="time" style="font-size: 16px;">正在获取时间...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 访问日志显示白框 -->
        <div class="white-box">
            <div class="van-col">
                <img src="biaoshi2.jpg">
                <h4>扫码信息:</h4>
                <span class="scan-info" id="scan-info">扫码0人0次</span>
                <button class="expand-button" id="toggle-log">展开</button>
            </div>
            <div id="visit-log" style="display: none; font-size: 16px;"></div>
        </div>

        <div class="image-container">
            <img src="jifen.jpg" alt="积分图片">
        </div>

    </div>  

    <script>
        // 检查是否通过二维码访问
        function isQRCodeVisit() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('fromQRCode') === 'true';
        }

        // 获取访问时间
        function getVisitTime() {
            const now = new Date();
            return now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
            });
        }

        // 获取地理位置
        function updateLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // 使用逆地理编码API获取具体位置
            const apiUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=zh`;
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const address = `${data.principalSubdivision} ${data.city} ${data.locality || data.localityInfo.administrative[2].name}`;
                    document.getElementById('address').textContent = address;
                    logVisit(address);
                })
                .catch(error => {
                    const errorMsg = '无法获取位置';
                    document.getElementById('address').textContent = errorMsg;
                    logVisit(errorMsg);
                    console.error('Error fetching location:', error);
                });
        }

        function handleLocationError() {
            const errorMsg = '位置获取失败';
            document.getElementById('address').textContent = errorMsg;
            logVisit(errorMsg);
        }

        // 记录访问日志并保存到localStorage
        function logVisit(address) {
            const time = getVisitTime();

            // 构建访问日志条目
            const logEntry = { address, time };

            // 从localStorage中获取当前日志
            let visitLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            let uniqueVisitors = JSON.parse(localStorage.getItem('uniqueVisitors')) || {};

            // 增加访问次数
            visitLog.push(logEntry);

            // 使用地址作为唯一标识符记录访问者
            if (!uniqueVisitors[address]) {
                uniqueVisitors[address] = true;
            }

            // 更新localStorage中的日志
            localStorage.setItem('visitLog', JSON.stringify(visitLog));
            localStorage.setItem('uniqueVisitors', JSON.stringify(uniqueVisitors));

            // 更新页面显示
            displayLog(visitLog);
            updateScanInfo(Object.keys(uniqueVisitors).length, visitLog.length);
        }

        // 显示访问日志
        function displayLog(logEntries) {
            const visitLogElement = document.getElementById('visit-log');
            visitLogElement.innerHTML = '';  // 清空之前的内容

            logEntries.forEach(entry => {
                const logItem = document.createElement('div');
                logItem.classList.add('log-entry');
                logItem.textContent = `${entry.time} - ${entry.address}`;
                visitLogElement.appendChild(logItem);
            });
        }

        // 更新扫码信息显示
        function updateScanInfo(uniqueVisitors, totalScans) {
            const scanInfoElement = document.getElementById('scan-info');
            scanInfoElement.textContent = `扫码${uniqueVisitors}人${totalScans}次`;
        }

        // 绑定展开/折叠日志功能
        document.getElementById('toggle-log').addEventListener('click', function() {
            const visitLogElement = document.getElementById('visit-log');
            if (visitLogElement.style.display === 'none') {
                visitLogElement.style.display = 'block';
                this.textContent = '折叠';
            } else {
                visitLogElement.style.display = 'none';
                this.textContent = '展开';
            }
        });

        // 页面加载完成后执行
        window.onload = function() {
            if (isQRCodeVisit()) {
                navigator.geolocation.getCurrentPosition(updateLocation, handleLocationError);
            }

            const storedLog = JSON.parse(localStorage.getItem('visitLog')) || [];
            const uniqueVisitors = Object.keys(JSON.parse(localStorage.getItem('uniqueVisitors')) || {}).length;
            displayLog(storedLog);
            updateScanInfo(uniqueVisitors, storedLog.length);

            // 更新访问时间
            const currentTime = getVisitTime();
            document.getElementById('time').textContent = currentTime;
        };
    </script>
</body>
</html>
